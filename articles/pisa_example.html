<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Case study: percentile distributions in test scores using PISA • perccalc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Case study: percentile distributions in test scores using PISA">
<meta property="og:description" content="perccalc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">perccalc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/perc_calculator_example.html">Case study: percentile distributions using the General Social Survey</a>
    </li>
    <li>
      <a href="../articles/perc_warning_example.html">Warning message with perccalc package</a>
    </li>
    <li>
      <a href="../articles/pisa_example.html">Case study: percentile distributions in test scores using PISA</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cimentadaj/perccalc/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Case study: percentile distributions in test scores using PISA</h1>
                        <h4 class="author">Jorge Cimentada</h4>
            
            <h4 class="date">2020-09-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cimentadaj/perccalc/blob/master/vignettes/pisa_example.Rmd"><code>vignettes/pisa_example.Rmd</code></a></small>
      <div class="hidden name"><code>pisa_example.Rmd</code></div>

    </div>

    
    
<p><code>perccalc</code> is very flexible and can be used for any ordered categorical variable which has a theoretical order, such as education or occupation. In this case study we will calculate the percentile difference in mathematics test scores based on the education of the parents for several countries using the PISA 2006 and PISA 2012 datasets. Let’s load our packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://cimentadaj.github.io/perccalc">perccalc</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://tidyr.tidyverse.org">tidyr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org">dplyr</a></span>)
</pre></div>
<p><code>percalc</code> automatically loads <code>pisa_2012</code> and <code>pisa_2006</code> which are two datasets with all the information that we need. These two datasets have data for Estonia, Germany and Spain and contain the five test scores in Mathematics and the father’s education in the international ISCED classification. The first thing we have to do is make sure the categories are ordered and calculate the average test score for each student.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">order_edu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"None"</span>,
               <span class="st">"ISCED 1"</span>,
               <span class="st">"ISCED 2"</span>,
               <span class="st">"ISCED 3A, ISCED 4"</span>,
               <span class="st">"ISCED 3B, C"</span>,
               <span class="st">"ISCED 5A, 6"</span>,
               <span class="st">"ISCED 5B"</span>)

<span class="co"># Make ordered categories of our categorical variables and calculate avgerage</span>
<span class="co"># math test scores for each year</span>
<span class="kw">pisa_2012</span> <span class="op">&lt;-</span>
  <span class="kw">pisa_2012</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(father_edu = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">father_edu</span>, levels = <span class="kw">order_edu</span>, ordered = <span class="fl">TRUE</span>))
         

<span class="kw">pisa_2006</span> <span class="op">&lt;-</span>
  <span class="kw">pisa_2006</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(father_edu = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">father_edu</span>, levels = <span class="kw">order_edu</span>, ordered = <span class="fl">TRUE</span>))


<span class="co"># Merge them together</span>
<span class="kw">pisa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">pisa_2006</span>, <span class="kw">pisa_2012</span>)
</pre></div>
<p>Once the categories are ordered, <code>perc_diff</code> can calculate the percentile difference between the 90th and 10th percentile for the complete sample. For example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="../reference/perc_diff.html">perc_diff</a></span>(data_model = <span class="kw">pisa</span>,
          categorical_var = <span class="kw">father_edu</span>,
          continuous_var = <span class="kw">avg_math</span>,
          percentiles = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">90</span>, <span class="fl">10</span>))
<span class="co">#&gt; difference         se </span>
<span class="co">#&gt;   45.07312   14.18308</span>
</pre></div>
<p>This means that the difference in Mathematics test scores between the 90th and 10th percentile of father education is 45 points with a standard error of 14 points. We can extrapolate this example for each country separately using <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code>. Since the result of <code>perc_diff</code> is a vector, to be able to work seamlessly with <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> we will use <code>perc_diff_df</code>, which returns the same results but as a data frame:</p>
<p>With <code>df_wrap</code> we can just pass that to <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::nest</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code> and calculate it separetely by year and country:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">

<span class="kw">cnt_diff</span> <span class="op">&lt;-</span>
  <span class="kw">pisa</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(data = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="kw">year</span>, <span class="op">-</span><span class="kw">CNT</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(edu_diff = <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">data</span>, <span class="fu">function</span>(<span class="kw">x</span>) <span class="fu"><a href="../reference/perc_diff.html">perc_diff_df</a></span>(<span class="kw">x</span>, <span class="kw">father_edu</span>, <span class="kw">avg_math</span>, percentiles = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">90</span>, <span class="fl">10</span>)))) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span><span class="kw">data</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="kw">edu_diff</span>)

<span class="kw">cnt_diff</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;    year CNT     difference    se</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1  2006 Estonia       18.3  5.55</span>
<span class="co">#&gt; 2  2006 Germany       61.2 28.8 </span>
<span class="co">#&gt; 3  2006 Spain         52.6 15.1 </span>
<span class="co">#&gt; 4  2012 Germany       45.0 27.4 </span>
<span class="co">#&gt; 5  2012 Spain         40.2 18.2 </span>
<span class="co">#&gt; 6  2012 Estonia       17.0  9.88</span>
</pre></div>
<p>We can see some big differences between, for example, Estonia and Spain. But even more interesting is plotting this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">cnt_diff</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">year</span>, <span class="kw">difference</span>, group = <span class="kw">CNT</span>, color = <span class="kw">CNT</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(name = <span class="st">"Achievement gap in Math between the 90th and \n 10th percentile of father's education"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(name = <span class="st">"Year"</span>)
</pre></div>
<p><img src="pisa_example_files/figure-html/unnamed-chunk-5-1.png" width="576" style="display: block; margin: auto;"></p>
<p>It looks like Estonia has a much smaller achievement gap relative to Spain and Germany but also note that both Germany and Spain have been decreasing their inequality. We can also try different achievement gaps to to explore the distribution:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">

<span class="co"># Calculate the gap for the 90/50 gap</span>
<span class="kw">cnt_half</span> <span class="op">&lt;-</span>
  <span class="kw">pisa</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(data = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="kw">year</span>, <span class="op">-</span><span class="kw">CNT</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(edu_diff = <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">data</span>,
                           <span class="fu">function</span>(<span class="kw">x</span>) <span class="fu"><a href="../reference/perc_diff.html">perc_diff_df</a></span>(<span class="kw">x</span>, <span class="kw">father_edu</span>, <span class="kw">avg_math</span>, percentiles = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">90</span>, <span class="fl">50</span>)))) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span><span class="kw">data</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="kw">edu_diff</span>)

<span class="co"># Calculate the gap for the 50/10 gap</span>
<span class="kw">cnt_bottom</span> <span class="op">&lt;-</span>
  <span class="kw">pisa</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(data = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="kw">year</span>, <span class="op">-</span><span class="kw">CNT</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(edu_diff = <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">data</span>,
                           <span class="fu">function</span>(<span class="kw">x</span>) <span class="fu"><a href="../reference/perc_diff.html">perc_diff_df</a></span>(<span class="kw">x</span>, <span class="kw">father_edu</span>, <span class="kw">avg_math</span>, percentiles = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">50</span>, <span class="fl">10</span>)))) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span><span class="kw">data</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="kw">edu_diff</span>)

<span class="kw">cnt_diff</span><span class="op">$</span><span class="kw">type</span> <span class="op">&lt;-</span> <span class="st">"90/10"</span>
<span class="kw">cnt_half</span><span class="op">$</span><span class="kw">type</span> <span class="op">&lt;-</span> <span class="st">"90/50"</span>
<span class="kw">cnt_bottom</span><span class="op">$</span><span class="kw">type</span> <span class="op">&lt;-</span> <span class="st">"50/10"</span>

<span class="kw">final_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">cnt_diff</span>, <span class="kw">cnt_half</span>, <span class="kw">cnt_bottom</span>)
<span class="kw">final_cnt</span><span class="op">$</span><span class="kw">type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">final_cnt</span><span class="op">$</span><span class="kw">type</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"90/10"</span>, <span class="st">"90/50"</span>, <span class="st">"50/10"</span>))
<span class="kw">final_cnt</span>
<span class="co">#&gt; # A tibble: 18 x 5</span>
<span class="co">#&gt;     year CNT     difference    se type </span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;</span>
<span class="co">#&gt;  1  2006 Estonia      18.3   5.55 90/10</span>
<span class="co">#&gt;  2  2006 Germany      61.2  28.8  90/10</span>
<span class="co">#&gt;  3  2006 Spain        52.6  15.1  90/10</span>
<span class="co">#&gt;  4  2012 Germany      45.0  27.4  90/10</span>
<span class="co">#&gt;  5  2012 Spain        40.2  18.2  90/10</span>
<span class="co">#&gt;  6  2012 Estonia      17.0   9.88 90/10</span>
<span class="co">#&gt;  7  2006 Estonia     -12.8   5.51 90/50</span>
<span class="co">#&gt;  8  2006 Germany       1.98 27.6  90/50</span>
<span class="co">#&gt;  9  2006 Spain        10.2  14.2  90/50</span>
<span class="co">#&gt; 10  2012 Germany     -17.5  23.5  90/50</span>
<span class="co">#&gt; 11  2012 Spain        -3.38 17.1  90/50</span>
<span class="co">#&gt; 12  2012 Estonia     -17.0   9.34 90/50</span>
<span class="co">#&gt; 13  2006 Estonia      31.2   5.55 50/10</span>
<span class="co">#&gt; 14  2006 Germany      59.2  26.6  50/10</span>
<span class="co">#&gt; 15  2006 Spain        42.4  13.9  50/10</span>
<span class="co">#&gt; 16  2012 Germany      62.4  26.1  50/10</span>
<span class="co">#&gt; 17  2012 Spain        43.6  17.1  50/10</span>
<span class="co">#&gt; 18  2012 Estonia      34.0   9.91 50/10</span>
</pre></div>
<p>Having this dataframe we can visualize all the three gaps in a very intuitive fashion:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">final_cnt</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">year</span>, <span class="kw">difference</span>, group = <span class="kw">CNT</span>, color = <span class="kw">CNT</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(name = <span class="st">"Achievement gap in Math between the 90th and \n 10th percentile of father's education"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(name = <span class="st">"Year"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span> <span class="kw">type</span>)
</pre></div>
<p><img src="pisa_example_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<p>It seems that the <code>90/50</code> and <code>50/10</code> differences are not symmetrical.</p>
<p><code>percalc</code> also has a <code>perc_dist</code> function which calculates the distribution of the percentiles, so we can compare more finegrained percentiles rather than differences:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="../reference/perc_dist.html">perc_dist</a></span>(<span class="kw">pisa</span>, <span class="kw">father_edu</span>, <span class="kw">avg_math</span>)
<span class="co">#&gt; # A tibble: 100 x 3</span>
<span class="co">#&gt;    percentile estimate std.error</span>
<span class="co">#&gt;         &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1          1    0.853      1.64</span>
<span class="co">#&gt;  2          2    1.74       3.20</span>
<span class="co">#&gt;  3          3    2.65       4.69</span>
<span class="co">#&gt;  4          4    3.60       6.10</span>
<span class="co">#&gt;  5          5    4.57       7.45</span>
<span class="co">#&gt;  6          6    5.57       8.72</span>
<span class="co">#&gt;  7          7    6.59       9.93</span>
<span class="co">#&gt;  8          8    7.64      11.1 </span>
<span class="co">#&gt;  9          9    8.71      12.2 </span>
<span class="co">#&gt; 10         10    9.80      13.2 </span>
<span class="co">#&gt; # … with 90 more rows</span>
</pre></div>
<p>Here we get the complete percentile distribution with the test score in mathematics for each percentile. This can be easily scaled to all country/year combinations with our previous code:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">cnt_dist</span> <span class="op">&lt;-</span>
  <span class="kw">pisa</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(data = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="kw">year</span>, <span class="op">-</span><span class="kw">CNT</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(edu_diff = <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">data</span>, <span class="fu">function</span>(<span class="kw">x</span>) <span class="fu"><a href="../reference/perc_dist.html">perc_dist</a></span>(<span class="kw">x</span>, <span class="kw">father_edu</span>, <span class="kw">avg_math</span>))) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span><span class="kw">data</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(<span class="kw">edu_diff</span>)

<span class="kw">cnt_dist</span>
<span class="co">#&gt; # A tibble: 600 x 5</span>
<span class="co">#&gt;     year CNT     percentile estimate std.error</span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;        &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1  2006 Estonia          1    0.647     0.388</span>
<span class="co">#&gt;  2  2006 Estonia          2    1.31      0.762</span>
<span class="co">#&gt;  3  2006 Estonia          3    2.00      1.12 </span>
<span class="co">#&gt;  4  2006 Estonia          4    2.71      1.47 </span>
<span class="co">#&gt;  5  2006 Estonia          5    3.43      1.81 </span>
<span class="co">#&gt;  6  2006 Estonia          6    4.17      2.13 </span>
<span class="co">#&gt;  7  2006 Estonia          7    4.93      2.44 </span>
<span class="co">#&gt;  8  2006 Estonia          8    5.70      2.74 </span>
<span class="co">#&gt;  9  2006 Estonia          9    6.48      3.02 </span>
<span class="co">#&gt; 10  2006 Estonia         10    7.28      3.30 </span>
<span class="co">#&gt; # … with 590 more rows</span>
</pre></div>
<p>Let’s limit the distribution only to the 10th, 20th, 30th… 100th percentile an compare for country/years:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">

<span class="kw">cnt_dist</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(year = <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw">year</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">percentile</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">100</span>, by = <span class="fl">10</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">percentile</span>, <span class="kw">estimate</span>, color = <span class="kw">year</span>, group = <span class="kw">percentile</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(color = <span class="st">"black"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(name = <span class="st">"Math test score"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(name = <span class="st">"Percentiles from father's education"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html">scale_color_discrete</a></span>(name = <span class="st">"Year"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span> <span class="kw">CNT</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>()
</pre></div>
<p><img src="pisa_example_files/figure-html/unnamed-chunk-10-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Here the red dots indicate the year 2006 and the bluish dots year 2012, the black line between them indicates the change over time. Here we can see that although Germany and Spain are decreasing (as we saw in the plot before), the composition of the change is very different: Spain’s decrease is big all around the distribution whereas Germany’s concentrate on the top percentiles.</p>
<p>This type of analysis serves well to disentangle and decompose distributions of ordered categorical. This vignette looked to show the power of this techniqe and how it can be used in practically any setting with an ordered categorical variable and a continuous variable.</p>
<p>If you use this in a publication, remember to cite the software as:</p>
<pre><code>#&gt; 
#&gt; To cite perccalc in publications use:
#&gt; 
#&gt;   Cimentada, (2019). perccalc: An R package for estimating percentiles
#&gt;   from categorical variables. Journal of Open Source Software, 4(44),
#&gt;   1796, https://doi.org/10.21105/joss.01796
#&gt; 
#&gt; A BibTeX entry for LaTeX users is
#&gt; 
#&gt;   @Article{,
#&gt;     doi = {10.21105/joss.01796},
#&gt;     url = {https://doi.org/10.21105/joss.01796},
#&gt;     year = {2019},
#&gt;     publisher = {The Open Journal},
#&gt;     volume = {4},
#&gt;     number = {44},
#&gt;     pages = {1796},
#&gt;     author = {Jorge Cimentada},
#&gt;     title = {perccalc: An R package for estimating percentiles from categorical variables},
#&gt;     journal = {Journal of Open Source Software},
#&gt;   }</code></pre>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jorge Cimentada.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
